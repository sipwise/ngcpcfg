#!/bin/bash
# Purpose: details about customized templates as part of ngcpcfg framework
################################################################################

set -e
set -u

# support testsuite
FUNCTIONS="${FUNCTIONS:-/usr/share/ngcp-ngcpcfg/functions/}"
HELPER="${HELPER:-/usr/share/ngcp-ngcpcfg/helper/}"
SCRIPTS="${SCRIPTS:-/usr/share/ngcp-ngcpcfg/scripts/}"

if ! [ -r "${FUNCTIONS}"/main ] ; then
  printf "Error: %s/main could not be read. Exiting.\n" "${FUNCTIONS}" >&2
  exit 1
fi

. "${FUNCTIONS}"/main

cd "${NGCPCTL_MAIN}"

show_customtt_list() {
  [ -z "${TEMPLATE_POOL_BASE}" ] && (echo "Error: undefined \$TEMPLATE_POOL_BASE" >&2 ; exit 1)
  log_debug "find \"${TEMPLATE_POOL_BASE}\" -name \"*\.customtt\.tt2*\""
  find "${TEMPLATE_POOL_BASE}" -name "*\.customtt\.tt2*"
}

show_customtt_effective() {
  log_debug "generate_template_list | grep customtt"
  generate_template_list | grep customtt
}


show_customtt_diff() {
  local customtt_files
  customtt_files=$(mktemp)

  [ -z "${NGCPCTL_MAIN}" ] && (echo "Error: undefined \$NGCPCTL_MAIN" >&2 ; exit 1)
  show_customtt_list | sed "s#${NGCPCTL_MAIN}##" | sed "s#^/##" > "${customtt_files}"

  if [ "$(wc -l < "${customtt_files}")" = "0" ] ; then
    echo "No customtt files found"
    rm -f "${customtt_files}"
    return
  fi

  while IFS= read -r customtt2_file ; do
    local tt2_file
    tt2_file="$(get_normalized_file "${customtt2_file}").tt2"

    if [ -f "${tt2_file}" ] ; then
      log_warning "Missing tt2 file for customtt '${customtt2_file}'"
      tt2_file="/dev/null"
    fi

    echo "diff -u '${tt2_file}' '${customtt2_file}'"
    diff -u "${tt2_file}" "${customtt2_file}" || true
    echo
  done < "${customtt_files}"

  rm -f "${customtt_files}"
}

case "${1:-}" in
  --show)
    show_customtt_list "$*"
    ;;
  --effective)
    show_customtt_effective "$*"
    ;;
  --diff)
    case "${2:-}" in
      --git)
        echo "TODO: ngcpcfg customtt --diff --git : $*"
        ;;
      --helper)
        echo "TODO: ngcpcfg customtt --diff --helper : $*"
        ;;
      *)
        show_customtt_diff "$*"
        ;;
    esac
    ;;
  --export)
    echo "TODO: ngcpcfg customtt --export : $*"
    ;;
  --import)
    case "${2:-}" in
      --dry-run)
        echo "TODO: ngcpcfg customtt --import --dry-run : $*"
        ;;
      *)
        echo "TODO: ngcpcfg customtt --import : $*"
        ;;
    esac
    echo "TODO: ngcpcfg customtt --import : $*"
    ;;
  *)
    show_customtt_list "$*"
    ;;
esac

exit 0

## END OF FILE #################################################################
